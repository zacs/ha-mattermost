name: "Validate and Test"

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main 
      - master

jobs:
  validate:
    runs-on: "ubuntu-latest"
    name: "Validate Integration"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "HACS Validation"
        uses: "hacs/action@main"
        with:
          category: "integration"
          ignore: "brands"

      - name: "Hassfest Validation"
        uses: "home-assistant/actions/hassfest@master"

  style:
    runs-on: "ubuntu-latest"
    name: "Check Code Style"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Setup Python"
        uses: "actions/setup-python@v4"
        with:
          python-version: "3.11"

      - name: "Install Black"
        run: python3 -m pip install black

      - name: "Check formatting with Black"
        run: black --check --diff .

      - name: "Install isort"
        run: python3 -m pip install isort

      - name: "Check import sorting with isort"
        run: isort --check-only --diff .

  validate-structure:
    runs-on: "ubuntu-latest"
    name: "Validate File Structure"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Check required files exist"
        run: |
          # Verify required files exist
          test -f custom_components/mattermost/__init__.py
          test -f custom_components/mattermost/config_flow.py
          test -f custom_components/mattermost/const.py
          test -f custom_components/mattermost/manifest.json
          test -f custom_components/mattermost/notify.py
          test -f custom_components/mattermost/services.yaml
          test -f custom_components/mattermost/translations/en.json
          echo "✓ All required files present"

      - name: "Validate JSON files"
        run: |
          python3 -c "import json; json.load(open('custom_components/mattermost/manifest.json'))"
          python3 -c "import json; json.load(open('custom_components/mattermost/translations/en.json'))"
          echo "✓ JSON files valid"

  lint:
    runs-on: "ubuntu-latest"
    name: "Lint Code"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Setup Python"
        uses: "actions/setup-python@v4"
        with:
          python-version: "3.11"

      - name: "Install flake8"
        run: python3 -m pip install flake8

      - name: "Run flake8"
        run: flake8 custom_components/ --count --select=E9,F63,F7,F82 --show-source --statistics